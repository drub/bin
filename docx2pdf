#!/bin/bash

# docx2pdf.sh - Batch convert .docx files to PDF using LibreOffice
# Converts all .docx files in the current working directory
# and writes the resulting PDFs to the specified output directory.
# Author: David Bacon
# Created: 2026-02-15

# Program version
PROG_VERSION="2.0"

# Locate LibreOffice binary: check PATH first, fall back to default macOS location
SOFFICE=$(which soffice 2>/dev/null || echo "/Applications/LibreOffice.app/Contents/MacOS/soffice")

# Verify LibreOffice is installed and executable
if [ ! -x "$SOFFICE" ]; then
    echo "docx2pdf v$PROG_VERSION"
    echo "Error: LibreOffice not found."
    exit 1
fi

# Display version banner
echo "docx2pdf v$PROG_VERSION"
echo ""

# Show help if no arguments provided or help flag is passed
if [ "$1" = "-h" ] || [ "$1" = "-help" ] || [ "$1" = "--help" ] || [ -z "$1" ]; then
    echo "Usage: $0 [-h | --help] <output-directory>"
    echo ""
    echo "Creates ............. <output-directory>"
    echo "Converts .docx files in the current directory to PDF."
    echo "Conversion tool ..... LibreOffice"
    echo ""
    echo "Options:"
    echo "  -h, --help          Show this help message"
    exit 0
fi

# Output directory from first argument; must not already exist
OUTPUT_DIR="$1"

if [ -e "$OUTPUT_DIR" ]; then
    echo "Error: '$OUTPUT_DIR' already exists."
    exit 1
fi

# Check for .docx files before creating output directory
DOCX_FILES=$(ls *.docx 2>/dev/null)
if [ -z "$DOCX_FILES" ]; then
    echo "No .docx files found in the current directory."
    exit 1
fi

# Display conversion settings and create output directory
echo "Conversion tool ..... LibreOffice"
echo "Output directory .... $OUTPUT_DIR"
echo ""
mkdir -p "$OUTPUT_DIR"

# Track number of successful conversions
COUNT=0

# Convert each .docx file to PDF using LibreOffice headless mode
for file in *.docx; do
    echo "Converting: $(basename "$file") -> $OUTPUT_DIR/$(basename "$file" .docx).pdf"
    if ! "$SOFFICE" --headless --convert-to pdf --outdir "$OUTPUT_DIR" "$file" > /dev/null 2>&1; then
        echo "Error: Failed to convert $(basename "$file")"
    else
        COUNT=$((COUNT + 1))
    fi
done

# Summary
echo ""
echo "Done. $COUNT file(s) converted to PDF."
