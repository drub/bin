#!/usr/bin/env python3

import os
import sys
import shutil
import subprocess
import glob

VERSION = "1.0"
SOFFICE = shutil.which("soffice") or "/Applications/LibreOffice.app/Contents/MacOS/soffice"

if not os.path.isfile(SOFFICE) or not os.access(SOFFICE, os.X_OK):
    print("Error: LibreOffice not found.")
    sys.exit(1)

print(f"docx2pdfp v{VERSION}")
print()

if len(sys.argv) < 2 or sys.argv[1] == "-h":
    print(f"Usage: {sys.argv[0]} <output-directory>")
    print()
    print("Creates ............. <output-directory>")
    print("Converts .docx files in the current directory to PDF.")
    print("Conversion tool ..... LibreOffice")
    sys.exit(0)

output_dir = sys.argv[1]

if os.path.exists(output_dir):
    print(f"Error: '{output_dir}' already exists.")
    sys.exit(1)

print("Conversion tool ..... LibreOffice")
print(f"Output directory .... {output_dir}")
print()
os.makedirs(output_dir)

docx_files = sorted(glob.glob("*.docx"))

if not docx_files:
    print("No .docx files found in the current directory.")
    sys.exit(1)

count = 0

for file in docx_files:
    basename = os.path.basename(file)
    pdf_name = os.path.splitext(basename)[0] + ".pdf"
    print(f"Converting: {basename} -> {output_dir}/{pdf_name}")

    result = subprocess.run(
        [SOFFICE, "--headless", "--convert-to", "pdf", "--outdir", output_dir, file],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )

    if result.returncode != 0:
        print(f"Error: Failed to convert {basename}")
    else:
        count += 1

print()
print(f"Done. {count} file(s) converted to PDF.")
